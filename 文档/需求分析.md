# 高校校内二手物品交易系统 - 需求分析说明书

## 1. 引言

### 1.1 项目背景

本项目旨在建立一个安全、便捷的高校校内二手物品交易平台。针对高校环境特殊的信任需求，系统将连接校内买家与卖家，通过实名认证和信誉体系解决交易信任问题。

### 1.2 目标与范围

系统涵盖前台用户交易业务与后台管理业务，核心目标是实现商品的生命周期管理、订单的高并发处理以及完善的风控互动机制。

## 2. 用户角色 

### 2.1 前台用户 

- **身份**：高校学生或教职工。
- **特征**：必须绑定学号/工号进行实名认证；拥有信誉积分体系；买卖一体（即同一账号既可以是买家也可以是卖家）。
- **权限**：商品发布、购买、评价、投诉、站内信沟通。

### 2.2 后台管理员 

- **身份**：系统运维人员、审核员、超级管理员。
- **特征**：基于 RBAC（基于角色的访问控制）模型管理，支持多角色（如超级管理员、审核员）和多部门归属。
- **权限**：用户管理、商品审核、投诉处理、查看平台统计数据。

## 3 功能需求 

### 3.1 用户与认证模块

- **实名认证**：用户注册必须绑定学号/工号，学号作为唯一实名凭证。
- **信誉体系**：系统记录用户信誉积分，支持对违规操作进行扣分，积分必须大于等于0。
- **账号管理**：支持账号“软删除”（注销），保留历史数据以维护数据完整性，但禁止该账号再次登录。

### 3.2 商品管理模块

- **分类管理**：支持多级树状商品分类结构（如：图书 -> 考研资料），支持无限层级。
- **商品生命周期**：
  - **发布**：用户发布商品后进入“待审核”状态。
  - **上架**：审核通过后商品状态变更为“上架”。
  - **下架/缺货**：库存为0时自动标记“缺货”，或由用户/管理员手动“下架/违规”。
  - **查询**：支持按分类、状态及发布时间筛选商品。
- **数据统计**：独立记录商品的浏览量与收藏量，并将高频写入的计数器字段垂直拆分，以支持高并发更新。

### 3.3 交易核心模块

- **购物车与结算**：支持购物车多商品合并结算。
- **订单拆分**：系统需自动根据卖家将大订单拆分为子订单（即一次支付可包含多个商家的订单）。
- **数据快照**：下单时必须记录“收货地址快照”与“成交价格快照”，防止后续用户修改地址或商品改价影响历史账单准确性。
- **库存控制**：
  - 下单时自动锁定库存（扣减库存）。
  - 取消订单时自动回滚库存。
  - 若库存回滚且商品非违规下架，需智能恢复商品为“上架”状态。
- **支付凭证**：支持用户上传支付凭证图片及流水号。

### 3.4 互动与风控模块

- **站内信**：买卖双方可针对具体商品发起私聊，支持标记消息阅读状态。
- **评价系统**：交易完成后双方互评（1-5分），支持文本内容，一条评价仅针对一个订单。
- **投诉举报**：用户可针对订单或商品发起投诉，需提交原因及证据图片，管理员可进行回复处理。

## 4. 数据与业务规则

### 4.1 数据完整性与一致性

- **价格约束**：商品价格与信誉积分必须非负。
- **级联处理**：
  - 删除用户时，级联删除其收藏记录，但保留订单数据（Restrict策略）以保证交易证据留存。
  - 取消订单时，触发器需智能判断：仅当商品因“自动售罄”下架时才在恢复库存后自动上架；若为“违规下架”则仅恢复库存不上架。
- **并发一致性**：下单过程需使用数据库事务及排他锁（FOR UPDATE），解析并排序商品列表以防止死锁和超卖。

### 4.2 性能与存储规则

- **冷热数据分离**：商品基本信息（低频修改）与统计信息（浏览/收藏量，高频修改）分表存储，优化锁竞争。
- **索引优化**：针对“商品广场筛选”、“待审核工作队列”、“超时未支付订单查询”等高频业务场景建立专用联合索引。
- **数据大屏**：系统需提供视图（View）以快速聚合全平台的活跃用户、GMV、成交订单等宏观数据。

## 5. 安全性需求

- **密码安全**：用户密码必须使用 BCrypt 加密存储，管理员密码需加盐（Salt）存储。
- **最小权限原则**：应用程序禁止使用 root 账户连接数据库。应创建专用应用账户，仅授予 DML（增删改查）和 Execute（执行存储过程）权限，严禁授予 DDL（建表/删表）权限，防止 SQL 注入破坏结构。
- **软删除机制**：核心数据（用户、商品）采用软删除（deleted_at 标记），保证数据可追溯。

## 6. 运行环境

- **操作系统**：Windows 11。
- **数据库**：MySQL 8.0.x (字符集 utf8mb4)